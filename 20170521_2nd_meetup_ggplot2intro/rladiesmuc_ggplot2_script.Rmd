---
title: "Making fRiends with: ggplot2"
author: "Pamela Matias"
date: "June 21st 2017"
output: html_document
---

***
# Outline
* Installing R and R Studio 
* Getting workshop files & data 
    + Download/Clone from GitHub
* Nice to meet you, ggplot2 
* Dataset: AirBnB in Berlin
* Basic types of plots
* Exercises

***

This is an [R Markdown](http://rmarkdown.rstudio.com) script. When you execute code within the notebook, the results appear beneath the code ;)  

You can go executing different code chunks individually by clicking the *Run* button at the top of the chunk or by placing your cursor inside it and pressing *Cmd+Shift+Enter*. You can also just run a single line if you highlight it and then press *Cmd+Enter*.

If you don't feel so comfortable working with RMarkdown, check out the available .R script in our workshop files - that you can just work with normally.

***

\pagebreak

## Installing R and RStudio 

Open a web browser and go to http://cran.r-project.org, then download and install it

RStudio would also be helpful (get at http://rstudio.com)

In R, install the ggplot2 package:
```{r}
#install.packages("ggplot2")
```


## Getting workshop files & data

All of the files are to be found here [20170521_2nd_meetup_ggplot2intro](https://github.com/pameliux/RLadies_MUC/tree/master/20170521_2nd_meetup_ggplot2intro)

You can clone the repo or simply download the files :)


***

## Nice to meet you, ggplot2 

So we are officially taking our first steps with [Hardley Wickhams package ggplot2](http://ggplot2.org). 
Check out this website for more detailed information. 

What are we aiming for here?
In the next 10 to 15 minutes we will understand the underlying grammar of ggplot2, and explore how to code and modify five basic plot types this package has to offer. 

Make sure to check out the official, updated info for the [ggplot2 package]  
(https://cran.r-project.org/web/packages/ggplot2/ggplot2.pdf)

*Warm-up questions*
What can one do with ggplot and why use it?
* ready-to-publish plots
* plot design at a high level of abstraction
* very flexible
* systematic structuring for polishing plot appearance
* mature and complete graphics system
* many users, active mailing list

What can't I do with ggplot2?
* 3-dimensional graphics (see the rgl package)
* Graph-theory type graphs (nodes/edges layout; see the igraph package)
* Interactive graphics (see the ggvis package)


***

## Dataset: AirBnB in Berlin! 

To do something slightly different from the classic iris and diamonds, today we'll be packing our bags and off to Berlin we go! 

Or at least we'll do so mentally, since we'll be taking a look at data from AirBnB in this German city (sorry, there was no data available for our beloved Munich #muchdisappointment).

Anyway, [Inside Airbnb](http://insideairbnb.com) is a project that uses publicly available information from the Airbnb web-site. It includes the availability calendar for 365 days in the future, and the reviews for each listing. Since every detail is taken from what is out there, there is no "private" information being used without people's consents - all of the host and place information is already available online.  

A lot of work has been put into verifying, cleaning, aggregating and analyzing the data by [an entire team](http://insideairbnb.com/behind.html), aand it's been made available below under a [Creative Commons CC0 1.0 Universal (CC0 1.0) "Public Domain Dedication"](http://creativecommons.org/publicdomain/zero/1.0/) license - so in case you're interested, you can also download and play around with tons and tons of data from [several other cities](http://insideairbnb.com/get-the-data.html).

Btw, the platform offers an online [visualization tool](http://insideairbnb.com/berlin/). Our ggplots will be cool enough, but it could be worth taking a look at this tool.

Now, let's get to work. We need to download the data and read it in R; this first chunk will make our lifes easier when importing it directly from GitHub:
```{r}
#install.packages("RCurl")
library(RCurl)
```

Note: There are two datasets online:

* The [raw data](https://raw.githubusercontent.com/pamelamatias/RLadies_MUC/master/20170521_2nd_meetup_ggplot2intro/workshop_files/Berlin_listings_raw.csv), as directly downloaded from Inside Airbnb:

* Our [workshop data](https://raw.githubusercontent.com/pamelamatias/RLadies_MUC/master/20170521_2nd_meetup_ggplot2intro/workshop_files/Berlin_listings_workshop.csv), which has some minor corrections for funny characters appearing in German names (such as the emoji looking o's and u's _mit umlaut_)

```{r}
# A bit of preprocessing

which(berlin$minimum_nights>200)

berlin<-read.csv("/Users/Pam/Documents/GitHub/rladies_munich/20170521_2nd_meetup_ggplot2intro/workshop_files/Berlin_listings_raw.csv")
berlin_raw <- berlin
berlin <- berlin[,!colnames(berlin)=="name"]
dim(berlin)
summary(berlin_raw)
berlin[which(berlin$minimum_nights>365),"minimum_nights"] <- NA

berlin<-read.csv("/Users/Pam/Documents/GitHub/rladies_munich/20170521_2nd_meetup_ggplot2intro/workshop_files/Berlin_listings_workshop.csv",stringsAsFactors=FALSE)

berlin$neighbourhood_group[which(berlin$neighbourhood_group=="Neuk\303\266lln")]<- "Neukoelln"
berlin$neighbourhood_group[which(berlin$neighbourhood_group=="Tempelhof - Sch\303\266neberg")] <- "Tempelhof - Schoeneberg"
berlin$neighbourhood_group[which(berlin$neighbourhood_group=="Treptow - K\303\266penick")] <- "Treptow - Koepenick"
berlin$neighbourhood_group <- as.factor(berlin$neighbourhood_group)
levels(berlin$neighbourhood_group)

summary(berlin)
berlin$id <- as.integer(berlin$id)
berlin$host_id <- as.integer(berlin$host_id)
berlin$host_name <- as.factor(berlin$host_name)
berlin$neighbourhood_group <- as.factor(berlin$neighbourhood_group)
berlin$neighbourhood <- as.factor(berlin$neighbourhood)
berlin$room_type <- as.factor(berlin$room_type)
berlin$number_of_reviews <- as.numeric(berlin$number_of_reviews)
berlin$last_review <- as.Date(berlin$last_review)
write.csv(berlin, "/Users/Pam/Documents/GitHub/rladies_munich/20170521_2nd_meetup_ggplot2intro/workshop_files/Berlin_listings_workshop.csv")

```

```{r}
# Option 1: Importing directly from GitHub using RCurl
x <- getURL("https://raw.githubusercontent.com/pamelamatias/RLadies_MUC/master/20170521_2nd_meetup_ggplot2intro/workshop_files/Berlin_listings_workshop.csv")
berlin <- read.csv(text = x, sep=";")

#Option 2: Download and save (or clone) data, then just type in the corresponding directory and off we go!
berlin<-read.table("/Users/Pam/Documents/GitHub/rladies_munich/20170521_2nd_meetup_ggplot2intro/workshop_files/Berlin_listings_workshop.csv", sep=";")

# Check nothing funny happened while we were importing it
head(berlin)
```

As you can see, `berlin` has >20k listings for AirBnB places in Berlin, and 15 observations per listing. This dataset is actually a snapshot of the listings available at a particular time (in this case, up to last month). Let's take a quick look at the variables:
```{r exploring_berlin_01}
#summary() of each variable: five-point statistics for numeric variables, while number of entries per levels in factors
str(berlin)
dim(berlin) #20584 x 15
summary(berlin)

```

***
## BaseGraphics vs ggplot2

Compared to base graphics, ggplot2:
* can be more verbose for simple plots
* is definitely less verbose for complex and custom graphics
* requires data to be in a data.frame
* uses a different system for adding plot elements as layers

Let's take another look at the example we had before

```{r}
hist(berlin$availability_365)
hist(berlin$number_of_reviews)
```


***  
## Basic types of plots

All we need to get started is defining our dataset (data =) and the variables we wish to see plotted on the x- and y-axis. 

Geometric objects, shortly geom_xy(), and is added in second step to the definition of our data space.

The package ggplot2 contains a number of geoms - here we get started with:
  *Scatter plots: geom_point()
*Line plots: geom_line()
*Bar charts and histograms: geom_bar(), geom_histogram()
*Box-plots: geom_boxplot(), stat_boxplot()
*Multiple facets of variables: facet_grid(), facet_wrap()




### 1 - Scatter plot

_Scatter plots are used to compare two continous variables_

####  2 continuous variables

Plot the relation of **
  
  [_words_](link)  

```{r scatter_01}
#definition of the data set and variables for each axis.
ggplot(berlin, aes(x = carat, y = price))

```

But? No graphic! What's wrong? We have to define how ggplot2 should illustrate our plot by adding a __geom_xy()__ (geometric object) of choice.

The __geom_point()__ creates a dot for each data point corresponding to the data.

```{r scatter_02}
#adding geom_point()
ggplot(berlin, aes(x = carat, y = price)) +
geom_point()

```

Here we go! Great, your first scatter plot.

#### Carat vs. Price and colored Cut

Let's add a third variable to make it more interesting. The _cut_ of a diamond affects the quality of a gemstone. How does it look like when we color the dots corresponding to the variable _cut_?

We are modifying the color of each dot. Therefore we have to define an aesthetics for each data point in the __geom_point()__ as shown below in the code.


```{r scatter_03}
#Color each dot regarding berlin cut
ggplot(berlin, aes(x = carat, y = price)) +
  geom_point(aes(color = cut))

```


### 2 - Line plot

_Line plots_ are useful for the visulaization of a discrete (x-axis) and a continous (y-axis) variable.

#### Cut vs. Price

```{r line_01}
#line plots and alpha (transparency)
ggplot(berlin, aes(x=carat, y=price, color=cut)) +
  geom_line(alpha=0.6)

```


### 3 - Histograms and bar charts

__geom_bar()__ and __geom_histogram()__ are geoms visualizing 1D area plots: bar charts are used for categorical x and
histograms for continous y-values.

The bar height reflects either a count of events in each group, or the exact values in a column of the data frame that is plotted. Therefore we only have to specify the variable x in the plot definition.


#### Bar chart

Visualization of counts per catogery. Here an example of the distribution of the number of berlin per clarity level.

Hint: For the illustration of exact values in a bar plot use _stat = 'identity'_ and add a definition of the y-value in the aesthetics _aes()_.

```{r bar_01}
#a simple bar chart
ggplot(berlin, aes(clarity)) + 
  geom_bar()

```

A stacked bar chart showing the distribution of counts in diamond clarity splitted by cut levels. The parameter _fill_ can be added either in the plot description or as aesthetics in the geom.

```{r bar_02}
#distinguishing categories in bar charts
ggplot(berlin, aes(clarity, fill=cut)) + 
  geom_bar()

#ggplot(berlin, aes(clarity) + 
#	geom_bar(aes(fill = cut))

```

Moving bars of one catogery next to each other by adding _position_ parameter. Dodge means: Adjust position by dodging / moving overlaps to the side.

```{r bar_03}
#dodging bar charts next to each other
ggplot(berlin, aes(clarity, fill=cut)) + 
  geom_bar(position="dodge")

#creates the same plot
#ggplot(berlin, aes(clarity, fill=cut)) + 
#	geom_bar(position=position_dodge())

```

#### Histogram

important parameter: binwidth, bin

The default is to use bins bins that cover the range of the data. You should always override this value, exploring multiple widths to find the best to illustrate the stories in your data.


```{r histogram_01}
#simple histogram showing the distribution of diamond prices
ggplot(berlin, aes(price)) +
  geom_histogram()

```

```{r hisogram_02}
#definition of number of bins
ggplot(berlin, aes(price)) +
  geom_histogram(bins = 200)
```


```{r histogram_03}
#definition of binwidth
ggplot(berlin, aes(price, fill = cut)) +
  geom_histogram(binwidth = 500)

```



### 4 - Boxplot

Boxplots are a helpful tool to compare different statistical parameters at one glance. 

The upper and lower box ends correspond to the first and third quantiles. The bar inside the box represents the median of the distribution.

```{r boxplot_01}
#a simple boxplot helps to compare distributions and related statistics
ggplot(berlin, aes(x=cut, y=price)) + 
  geom_boxplot()


```


How to add whisker? Use the integrated statistics _stat_xy_ of __ggplot2__. Statistics calculate and return values based on the graph definition and are directly applied.

```{r boxplot_02}
#stat_boxplot for defining whisker
ggplot(berlin, aes(x = cut, y = price))  + 
  stat_boxplot(geom ='errorbar', width = 0.65) + 
  geom_boxplot() 				# or: stat_boxplot(geom='boxplot')

```

Also boxplots are distinguishable by another catogery using the _fill_ in aesthetics _aes()_.

```{r boxplot_03}
#boxplot grouping prices per color for each cut level, transformation y-axis into log-scale
ggplot(berlin, aes(x = cut, y = price, fill = color)) + 
  geom_boxplot() + 
  scale_y_log10()

```



### 5 - Multiple facets

The package __ggplot2__ offers two different ways of splitting a complex graph into multiple facets by a single factor or maximum two factors. 

_facet_wrap()_ arranges the separate facets subsequently next to each other. The number of rows and columns can be defined as additional parameter.


```{r multiple_01}
#splitted by color and arranged in the two rows
ggplot(berlin, aes( x = carat, y = price))+
  geom_point(aes(color = clarity))+
  facet_wrap(~color, nrow = 2)

```

_facet_grid()_ creates a matrix-based arrangement of our plots. Dataset factors are separated by the symbol "~". If there is only a single paramter applied as x coordinate, the second one has to be coded with a placeholder ".", e.g., + facet_grid(color ~ .).

```{r multiple_02}
#same plot - more beautiful
ggplot(berlin, aes(carat, price, color = clarity)) +
  geom_point() +
  facet_grid(color~clarity)+                     	#splitted into grid / matrix (x ~ y)
  theme(axis.text = element_text(size = 6),       #modifying grid parameter: smaller text sizees
        strip.text = element_text(size = 8)) +
  scale_color_manual(values = brewer.pal(8, 'Spectral'))+		#changing colors using RColorBrewer
  ggtitle('A beautiful ggplot2')	#plot title

```


## It's your turn!

###__Task #1:__

Description of the plot:
  
  *x-axis: clarity
*y-axis: counts
*grouping: cut (labels right side of graphs)
*color: cut
*additional: plots below each other in one column, splitted by cut


```{r you_01}
#start here



```



###__Task #2:__

Description of the plot:
  
  *x-axis: clarity
*y-axis: counts
*grouping: cut (labels right side of graphs)
*color: cut
*additional: bars next to each other per condition

```{r you_02}
#your second trial

```


###__Task #3:__

Description of the plot:
  
  *x-axis: price
*y-axis: counts, normalized to 1, stacked
*grouping: cut
*binwidth: 500

```{r you_03}
#the final one


```


## Further information

### Useful commands
Here are summarised the most common commands and parameters of __ggplot2__. Just play with them and see how they are working.

```{r commands_ggplot2, tidy=TRUE}

# coord_flip()   											- rotates your plot
# theme_bw()													- a black and white scheme
# aes(shape = , color = )							- define a variable to this parameter inside aes() and modify the shape of points or the color
# aes(fill = )												- use to distinguish a variable in a bar plot, histogram or boxplot
# scale_fill/color_manual()						- define your own colors

```


### Examples, help and used resources

Here are some further links covering stuff we had no time to go over, and also some we used while preparing this workshop. Sharing is caring!
  
* [Cookbook for R](http://www.cookbook-r.com)
* [ggplot2 cheat sheet](https://www.rstudio.com/wp-content/uploads/2015/03/ggplot2-cheatsheet.pdf)
* [stackoverflow](http://stackoverflow.com)
* [ggplot2 Harvard tutorial](http://tutorials.iq.harvard.edu/R/Rgraphics/Rgraphics.html)












